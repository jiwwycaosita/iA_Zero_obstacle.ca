# Prometheus configuration for Legal Ingest monitoring

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'legal-ingest'
    environment: 'production'

# Alertmanager configuration (optional)
# alerting:
#   alertmanagers:
#     - static_configs:
#         - targets:
#           - alertmanager:9093

# Scrape configurations
scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Legal ingest workers (Server 1)
  - job_name: 'legal-ingest-workers-s1'
    static_configs:
      - targets:
        - 'worker1:9090'
        - 'worker2:9090'
        - 'worker3:9090'
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '(.+):.+'
        replacement: '${1}'

  # Legal ingest workers (Server 2)
  - job_name: 'legal-ingest-workers-s2'
    static_configs:
      - targets:
        - 'worker4:9090'
        - 'worker5:9090'
        - 'worker6:9090'

  # OpenSearch
  - job_name: 'opensearch'
    static_configs:
      - targets: ['opensearch:9200']
    metrics_path: '/_prometheus/metrics'

  # Postgres (with postgres_exporter)
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']

  # MinIO
  - job_name: 'minio'
    bearer_token: YOUR_MINIO_TOKEN
    metrics_path: /minio/v2/metrics/cluster
    scheme: http
    static_configs:
      - targets: ['minio:9000']

  # API server (PlanetHoster)
  - job_name: 'legal-api'
    static_configs:
      - targets: ['api:8000']
    metrics_path: '/metrics'

  # Node exporter (system metrics)
  - job_name: 'node'
    static_configs:
      - targets:
        - 'server1:9100'
        - 'server2:9100'

# Recording rules
rule_files:
  - 'rules/*.yml'

# Example recording rules (create rules/ directory)
# groups:
#   - name: legal_ingest_rules
#     interval: 30s
#     rules:
#       - record: job:documents_processed_rate:5m
#         expr: rate(documents_processed_total[5m])
#
#       - record: job:scraping_errors_rate:5m
#         expr: rate(documents_processed_total{status="error"}[5m])
